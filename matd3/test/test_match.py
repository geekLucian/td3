import unittest
from RangeEnv import RangeEnv


class TestMatch(unittest.TestCase):
    """Partition based on matching end condition"""
    def debug_get_match_result(self, _action, mode="normal"):
        match_result, end_reason = RangeEnv.get_match_result(_action, mode)
        print("交易记录:\n [[buyer_name, seller_name, match_volume, match_price]]\n\t\b",
              '\n\t'.join(map(str, match_result)))
        print("共{}条，出清中止原因：{}".format(len(match_result), end_reason))
        return match_result, end_reason

    # TODO: load testcases from file
    def test_sellers_sold_out(self):
        #         [seller0_price_lower, seller0_price_upper, seller0_volume, ...,
        _action = [339.00296390727857, 349.7814391472078, 67946.77068732973,
                   358.8683969319527, 360.4567261319611, 62794.382900008786,
                   328.32765239104657, 332.0494422963056, 38440.049913458395,
                   343.73105406749613, 363.13000738472374, 68772.89864387985,
                   365.46256262658426, 368.65860762904265, 41020.24625034926,
                   376.90462218909283, 379.9156567926043, 58138.36061604663,
                   335.19114195390955, 337.99962816941775, 52856.75277755191,
                   337.6729876147545, 359.1125081428336, 61751.428407131636,
                   360.23506683084014, 374.0580291831231, 37940.9755018392,
                   329.65292832280693, 349.9152620195559, 58493.152306704156,
                   # buyer0_price,      placeholder,         buyer0_volume, ...]
                   345.9768195330096, 0, 101176.75458093133,
                   360.38289426488126, 0, 80347.16160834608,
                   359.724424518164, 0, 144566.90571888624,
                   343.6406364951086, 0, 64912.110490920124,
                   348.28721029581584, 0, 73350.72195948445,
                   375.5238053384502, 0, 57120.70958225794,
                   339.0689582604888, 0, 60043.50895167307,
                   353.6377359250006, 0, 38402.1299235049,
                   318.30226949367545, 0, 32248.33150230246,
                   356.3416064801433, 0, 6978.361461852608]
        #       [buyer_name, seller_name, match_volume, match_price]
        _truth = [[5, 2, 38440.049913458395, 352.25704784768845],
                  [5, 9, 18680.659668799548, 353.18749532400324],
                  [1, 9, 39812.49263790461, 345.6170397872188],
                  [1, 6, 40534.668970441475, 348.40747952460663],
                  [2, 6, 12322.083807110437, 348.07824465124804],
                  [2, 7, 61751.428407131636, 348.78036620512506],
                  [2, 0, 67946.77068732973, 350.54571675277566],
                  [2, 3, 2546.6228173144336, 353.240335562758],
                  [9, 3, 6978.361461852608, 351.5489265437476],
                  [7, 3, 38402.1299235049, 350.19699126617627],
                  [4, 3, 20845.784441207907, 347.5217284515839]]
        _match_result, _ = self.debug_get_match_result(_action)
        self.assertEqual(_match_result, _truth)

    def test_no_more_pairs(self):
        _action = [329.6369514465332, 351.6155160191929, 49200.560027480125,
                   338.9265112876892, 342.5413241489154, 50594.022253513336,
                   329.0849575996399, 338.6838995129262, 44720.75809657574,
                   350.52417850494385, 353.89575720030086, 69051.62560641766,
                   345.4413856267929, 390.5433321169308, 44095.910274505615,
                   346.7970378398895, 359.4954600956114, 70344.21908557415,
                   339.1159427165985, 350.78961743657896, 37338.00921535492,
                   323.78358244895935, 356.87795106683905, 48699.23500204086,
                   341.4933223724365, 345.14823941266695, 63140.12389087677,
                   331.6401882171631, 338.4804022680835, 31500.63673400879,
                   354.26789021492004, 0, 82076.52778840065,
                   349.2439988851547, 0, 63219.365176320076,
                   360.1553860902786, 0, 123989.33934688568,
                   354.44252920150757, 0, 52013.56042158604,
                   358.8302297592163, 0, 88513.07495617867,
                   361.0858074426651, 0, 38722.26921606064,
                   353.2797602415085, 0, 49434.99908769131,
                   353.6352334022522, 0, 44436.31066274643,
                   359.6153789758682, 0, 33738.86096525192,
                   347.17684185504913, 0, 5975.596432924271]
        _truth = [[5, 7, 38722.26921606064, 343.76003873348236],
                  [2, 7, 9976.965785980225, 343.2948280572891],
                  [2, 2, 44720.75809657574, 344.7581703066826],
                  [2, 0, 49200.560027480125, 345.3969779610634],
                  [2, 9, 20091.055436849594, 347.60784066645095],
                  [8, 9, 11409.581297159195, 347.33783710924575],
                  [8, 1, 22329.279668092728, 349.31830298900604],
                  [4, 1, 28264.74258542061, 348.9257283806801],
                  [4, 6, 37338.00921535492, 349.5674311518669],
                  [4, 8, 22910.323155403137, 350.42377650994615],
                  [3, 8, 40229.80073547363, 348.2299262310918],
                  [3, 4, 11783.759686112404, 350.2808704674244],
                  [0, 4, 32312.15058839321, 350.19355097413063],
                  [0, 5, 49764.37720000744, 351.46424919366837],
                  [7, 5, 20579.84188556671, 351.14792078733444],
                  [7, 3, 23856.468777179718, 352.1460656865068],
                  [6, 3, 45195.15682923794, 351.96832910613495]]
        _match_result, _ = self.debug_get_match_result(_action)
        self.assertEqual(_match_result, _truth)

    def test_reverse_matching(self):
        _action = [329.6369514465332, 351.6155160191929, 49200.560027480125,
                   338.9265112876892, 342.5413241489154, 50594.022253513336,
                   329.0849575996399, 338.6838995129262, 44720.75809657574,
                   350.52417850494385, 353.89575720030086, 69051.62560641766,
                   345.4413856267929, 390.5433321169308, 44095.910274505615,
                   346.7970378398895, 359.4954600956114, 70344.21908557415,
                   339.1159427165985, 350.78961743657896, 37338.00921535492,
                   323.78358244895935, 356.87795106683905, 48699.23500204086,
                   341.4933223724365, 345.14823941266695, 63140.12389087677,
                   331.6401882171631, 338.4804022680835, 31500.63673400879,
                   354.26789021492004, 0, 82076.52778840065,
                   349.2439988851547, 0, 63219.365176320076,
                   360.1553860902786, 0, 123989.33934688568,
                   354.44252920150757, 0, 52013.56042158604,
                   358.8302297592163, 0, 88513.07495617867,
                   361.0858074426651, 0, 38722.26921606064,
                   353.2797602415085, 0, 49434.99908769131,
                   353.6352334022522, 0, 44436.31066274643,
                   359.6153789758682, 0, 33738.86096525192,
                   347.17684185504913, 0, 5975.596432924271]
        _truth = [[3, 8, 52013.56042158604, 349.1436554911494],
                    [4, 8, 11126.563469290733, 351.33750577000376],
                    [4, 6, 37338.00921535492, 352.485849831862],
                    [4, 1, 40048.50227153301, 349.82943159598665],
                    [8, 1, 10545.519981980324, 350.2220062043126],
                    [8, 9, 23193.3409832716, 349.04789062197585],
                    [2, 9, 8307.29575073719, 349.31789417918105],
                    [2, 0, 49200.560027480125, 350.8916191042283],
                    [2, 2, 44720.75809657574, 347.1579057850042],
                    [2, 7, 21760.72547209263, 351.5684202117591],
                    [5, 7, 26938.509529948235, 352.0336308879523]]
        print("Test reverse")
        _match_result, _ = self.debug_get_match_result(_action, mode="reverse")
        self.assertEqual(_match_result, _truth)

    def test_volume_matching(self):
        _action = [329.6369514465332, 351.6155160191929, 49200.560027480125,
                   338.9265112876892, 342.5413241489154, 50594.022253513336,
                   329.0849575996399, 338.6838995129262, 44720.75809657574,
                   350.52417850494385, 353.89575720030086, 69051.62560641766,
                   345.4413856267929, 390.5433321169308, 44095.910274505615,
                   346.7970378398895, 359.4954600956114, 70344.21908557415,
                   339.1159427165985, 350.78961743657896, 37338.00921535492,
                   323.78358244895935, 356.87795106683905, 48699.23500204086,
                   341.4933223724365, 345.14823941266695, 63140.12389087677,
                   331.6401882171631, 338.4804022680835, 31500.63673400879,
                   354.26789021492004, 0, 82076.52778840065,
                   349.2439988851547, 0, 63219.365176320076,
                   360.1553860902786, 0, 123989.33934688568,
                   354.44252920150757, 0, 52013.56042158604,
                   358.8302297592163, 0, 88513.07495617867,
                   361.0858074426651, 0, 38722.26921606064,
                   353.2797602415085, 0, 49434.99908769131,
                   353.6352334022522, 0, 44436.31066274643,
                   359.6153789758682, 0, 33738.86096525192,
                   347.17684185504913, 0, 5975.596432924271]
        _truth = [[2, 5, 70344.21908557415, 354.40799713134766],
                    [2, 3, 53645.12026131153, 355.40614203052],
                    [4, 3, 15406.505345106125, 354.74356386498886],
                    [4, 8, 63140.12389087677, 350.42377650994615],
                    [4, 1, 9966.44572019577, 348.9257283806801],
                    [0, 1, 40627.576533317566, 346.64455860853195],
                    [0, 0, 41448.951255083084, 342.4532300233841],
                    [1, 0, 7751.608772397041, 339.94128435850143],
                    [1, 7, 48699.23500204086, 337.8391344547272],
                    [1, 2, 6768.521401882172, 339.30247670412064],
                    [3, 2, 37952.236694693565, 341.90174186229706],
                    [3, 4, 14061.323726892471, 350.2808704674244],
                    [6, 4, 30034.586547613144, 349.69948598742485],
                    [6, 6, 19400.412540078163, 346.792196393013],
                    [7, 6, 17937.596675276756, 346.96993297338486],
                    [7, 9, 26498.713987469673, 344.34776432243774],
                    [5, 9, 5001.922746539116, 348.0730513426442]]
        print("Test volume")
        _match_result, _ = self.debug_get_match_result(_action, mode="volume")
        self.assertEqual(_match_result, _truth)



if __name__ == '__main__':
    unittest.main()
